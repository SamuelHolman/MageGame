<html>

<% include ./partials/header %>

<body>
    <% include ./partials/navbar %>
    <% include ./partials/scripts %>

    <p class="topleft" id="info"></p>
    <canvas id="GameArea"></canvas>

    <script>
        let WindowHeight = $(window).height();
        let WindowWidth = $(window).width();
        let MapCoordinateX = 1000;
        let MapCoordinateY = 1000;
        let PlayerXSize = 50;
        let PlayerYSize = 50;
        let MapSizeX = 10000;
        let MapSizeY = 10000;
        let XOffset = WindowWidth / 2;
        let YOffset = WindowHeight / 2;
        let PlayerCoordinateX = MapCoordinateX + XOffset;
        let PlayerCoordinateY = MapCoordinateY + YOffset;
        let TimerCheckUp = null;
        let TimerCheckDown = null;
        let TimerCheckLeft = null;
        let TimerCheckRight = null;
        let MovementAmount = 2;
        let Delay = 8;
        let MousePositionX = WindowWidth / 2;
        let MousePositionY = WindowHeight / 2;
        let IsPlayerMoving = false;
        let CoordinateX;
        let CoordinateY;
        let CoordinateSize = 1000;

        let MapPlacement = [
            [0, 0, 1, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 1, 1, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [1, 1, 0, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
        ]


        document.addEventListener('contextmenu', event => event.preventDefault());

        var GameAreaSelector = document.getElementById("GameArea");
        var game = GameAreaSelector.getContext("2d");

        window.requestAnimationFrame(GameFrame);

        GameMap = new Image();
        Player = new Image();
        Kaiju = new Image();

        function GameFrame() {
            GameMap.src = '/images/Map.png';
            RenderMapObjects();
            RenderObjects();
            FindCoordinate();
            $("#info").text(`X: ${CoordinateX}, Y: ${CoordinateY}`);
            window.requestAnimationFrame(GameFrame);
        }

        let PlayerStaticAnimation = true;
        PlayerStillAnimationTimer = setInterval(PlayerAnimate, 750);

        function PlayerAnimate() {
            PlayerStaticAnimation = !PlayerStaticAnimation;
        }

        function resize() {
            GameAreaSelector.width = window.innerWidth;
            WindowWidth = window.innerWidth;
            GameAreaSelector.height = window.innerHeight;
            WindowHeight = window.innerHeight;
            XOffset = WindowWidth / 2;
            YOffset = WindowHeight / 2;
        }

        resize()
        window.addEventListener('resize', resize)

        GameMap.onload = function () {
            game.fillStyle = "#654987";
            game.fillRect(-1000, -1000, MapSizeX + 1000, MapSizeY + 1000);
            game.drawImage(GameMap, MapCoordinateX, MapCoordinateY, WindowWidth, WindowHeight, 0, 0, WindowWidth, WindowHeight);
        }

        Player.onload = function () {
            // game.drawImage(Player, WindowWidth / 2 - 50, WindowHeight / 2 - 50, 100, 100);
            if (PlayerStaticAnimation) {
                if (IsPlayerMoving) {
                    game.drawImage(Player, 0, 0, 125, 250, WindowWidth / 2 - 50, WindowHeight / 2 - 50, 100, 100);
                } else {
                    game.drawImage(Player, 0, 0, 250, 125, WindowWidth / 2 - 50, WindowHeight / 2 - 50, 100, 100);
                }
            } else if (!PlayerStaticAnimation) {
                if (IsPlayerMoving) {
                    game.drawImage(Player, 125, 0, 125, 250, WindowWidth / 2 - 50, WindowHeight / 2 - 50, 100, 100);
                } else {
                    game.drawImage(Player, 0, 125, 250, 125, WindowWidth / 2 - 50, WindowHeight / 2 - 50, 100, 100);
                }
            }
        }

        Kaiju.onload = function () {
            LocationsX = [100, 200, 300, 400, 500, 600, 700, 800];
            LocationsY = [200, 100, 500, 1000, 5000, 60, 750, 350];
            for (i = 0; i < 8; i++) {
                game.drawImage(Kaiju, LocationsX[i] - MapCoordinateX, LocationsY[i] - MapCoordinateY, 100, 100);
            }
        }

        GameMap.src = '/images/Map.png';

        function RenderMapObjects() {
            for (y = 0; y < 10000; y += 1000) {
                for (x = 0; x < 10000; x += 1000) {
                    if (MapPlacement[y / 1000][x / 1000] == 1) {
                        game.fillStyle = "#128377";
                        game.fillRect(x - MapCoordinateX, y - MapCoordinateY, CoordinateSize, CoordinateSize);
                    }
                }
            }
        }

        function RenderObjects() {
            Player.src = '/images/TestCharacters/LongLegs/LongLeggedUp.png';
            Kaiju.src = '/images/PlanetSnail.png';

            game.fillStyle = "#123456";
            game.fillRect(500 - MapCoordinateX, 500 - MapCoordinateY, PlayerXSize, PlayerYSize);
            game.fillStyle = "#654321";
            game.fillRect(5000 - MapCoordinateX, 5000 - MapCoordinateY, PlayerXSize, PlayerYSize);
        }



        function GetAngle(PointX, PointY, PlayerX, PlayerY) {
            return Math.atan2(PointY - PlayerY, PointX - PlayerX) * 180 / Math.PI;
        }

        function SyncPlayerCoordinates() {
            PlayerCoordinateX = MapCoordinateX + XOffset;
            PlayerCoordinateY = MapCoordinateY + YOffset;
        }

        function FindCoordinate() {
            CoordinateX = (PlayerCoordinateX - PlayerCoordinateX % CoordinateSize) / CoordinateSize;
            CoordinateY = (PlayerCoordinateY - PlayerCoordinateY % CoordinateSize) / CoordinateSize;
        }

        function CheckMovement() {
            FindCoordinate();
            // if () {

            // }
        }

        function Move(Direction) {
            // console.log(`${PlayerCoordinateX} ${PlayerCoordinateY} ${MapSizeX} ${MapSizeY}`);
            IsPlayerMoving = true;
            SyncPlayerCoordinates();
            switch (Direction) {
                case 1:
                    if (PlayerCoordinateY >= 0) {
                        MapCoordinateY -= MovementAmount;
                    }
                    break;
                case 2:
                    if (PlayerCoordinateY <= MapSizeY) {
                        MapCoordinateY += MovementAmount;
                    }
                    break;
                case 3:
                    if (PlayerCoordinateX >= 0) {
                        MapCoordinateX -= MovementAmount;
                    }
                    break;
                case 4:
                    if (PlayerCoordinateX <= MapSizeX) {
                        MapCoordinateX += MovementAmount;
                    }
                    break;
            }
        }

        $("body").keydown(function (Key) {
            if (Key.which == 87) {
                if (TimerCheckUp == null) {
                    TimerCheckUp = setInterval(Move, Delay, 1);
                }
            } else if (Key.which == 83) {
                if (TimerCheckDown == null) {
                    TimerCheckDown = setInterval(Move, Delay, 2);
                }
            } else if (Key.which == 65) {
                if (TimerCheckLeft == null) {
                    TimerCheckLeft = setInterval(Move, Delay, 3);
                }
            } else if (Key.which == 68) {
                if (TimerCheckRight == null) {
                    TimerCheckRight = setInterval(Move, Delay, 4);
                }
            } else if (Key.which == 90) {
                alert(`${WindowWidth} ${WindowHeight}`);
            }
        });

        $("body").keyup(function (Key) {
            if (Key.which == 87) {
                clearInterval(TimerCheckUp);
                TimerCheckUp = null;
                IsPlayerMoving = false;
            } else if (Key.which == 83) {
                clearInterval(TimerCheckDown);
                TimerCheckDown = null;
                IsPlayerMoving = false;
            } else if (Key.which == 65) {
                clearInterval(TimerCheckLeft);
                TimerCheckLeft = null;
                IsPlayerMoving = false;
            } else if (Key.which == 68) {
                clearInterval(TimerCheckRight);
                TimerCheckRight = null;
                IsPlayerMoving = false;
            } else if (Key.which == 90) {
                //Use();
            } else if (Key.which == 85) {
                document.getElementById("GameArea").requestFullscreen();
            }
            // alert(Key.which);
        });

        $('#GameArea').mousedown(function (event) {
            switch (event.which) {
                case 1:
                    // alert('Left Mouse button pressed.');
                    // alert(`${MousePositionX}, ${MousePositionY}`);
                    FindCoordinate();
                    // alert(`${CoordinateX}, ${CoordinateY}, ${MapPlacement[CoordinateY][CoordinateX]}`);
                    break;
                case 2:
                    // alert('Middle Mouse button pressed.');
                    break;
                case 3:
                    // alert('Right Mouse button pressed.');
                    alert(`${MousePositionX + MapCoordinateX}, ${MousePositionY + MapCoordinateY}`);
                    break;
                default:
                // alert('You have a strange Mouse!');
            }
        });

        $("#GameArea").mousemove(function (event) {
            MousePositionX = event.pageX - $(this).offset().left;
            MousePositionY = event.pageY - $(this).offset().top;
            console.log(`${GetAngle(MousePositionX, MousePositionY, PlayerCoordinateX, PlayerCoordinateY)}`);
        });

    </script>
</body>

</html>